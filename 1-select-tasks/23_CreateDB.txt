CREATE TABLE [Formula](
[Id] INT IDENTITY(1,1) NOT NULL,
[Code] NVARCHAR(20) NOT NULL DEFAULT '',
[Description] NVARCHAR(120) NOT NULL DEFAULT '',
[FormulaPurpose] TINYINT NOT NULL DEFAULT 1,
[FormulaType] TINYINT NOT NULL DEFAULT 1,
[HasSubExpression] BIT NOT NULL DEFAULT 0,
[SubExpressionCount] TINYINT NOT NULL DEFAULT 0,
[EditableExpression] NVARCHAR(MAX) NOT NULL DEFAULT '',
[EvalExpression] NVARCHAR(MAX) NOT NULL DEFAULT '',
[ActivationDate] DATE NOT NULL,
[Notes] NVARCHAR(MAX) NOT NULL DEFAULT '',
[IsActive]  BIT NOT NULL DEFAULT 1,
[CreatedBy] INT NOT NULL DEFAULT 0,
[ModifiedBy] INT NOT NULL DEFAULT 0,
[DateCreated] DATETIME2(7) NOT NULL DEFAULT GETDATE(),
[DateModified] DATETIME2(7) NOT NULL DEFAULT GETDATE(),
[Ts] TIMESTAMP NOT NULL,
CONSTRAINT [PK_Formula_Id] PRIMARY KEY([Id]),
CONSTRAINT [IDX_Formula_Code_U_N] UNIQUE ([Code]));

CREATE TABLE [FormulaSubExpression](
[Id] INT IDENTITY(1,1) NOT NULL,
[FormulaId] INT NOT NULL,
[Description] NVARCHAR(80) NOT NULL DEFAULT '',
[SubExprIndex] TINYINT NOT NULL DEFAULT 0,
[EditableSubExpression] NVARCHAR(2000) NOT NULL DEFAULT '',
[EvalSubExpression] NVARCHAR(2000) NOT NULL DEFAULT '',
[CreatedBy] INT NOT NULL DEFAULT 0,
[ModifiedBy] INT NOT NULL DEFAULT 0,
[DateCreated] DATETIME2(7) NOT NULL DEFAULT GETDATE(),
[DateModified] DATETIME2(7) NOT NULL DEFAULT GETDATE(),
[Ts] TIMESTAMP NOT NULL,
CONSTRAINT [FK_FormulaSubExpression_FormulaId_Formula_Id] FOREIGN KEY ([FormulaId]) REFERENCES [Formula] ([Id]),
CONSTRAINT [PK_FormulaSubExpression_Id] PRIMARY KEY([Id]));

CREATE TABLE [FormulaVariableSet](
[Id] INT IDENTITY(1,1) NOT NULL,
[Code] NVARCHAR(50) NOT NULL DEFAULT '',
[Description] NVARCHAR(80) NOT NULL DEFAULT '',
[CanonicalDataType] TINYINT NOT NULL DEFAULT 1,
[EvalScope] TINYINT NOT NULL DEFAULT 1,
[ConstantValue] NVARCHAR(2000) NOT NULL DEFAULT '',
[ResolutionType] TINYINT NOT NULL DEFAULT 1,
[SqlExpr] NVARCHAR(4000) NOT NULL DEFAULT '',
[EvalExpr] NVARCHAR(4000) NOT NULL DEFAULT '',
[ParamsNumberSqlExpr] TINYINT NOT NULL DEFAULT 0,
[ParamsNumberEvalExpr] TINYINT NOT NULL DEFAULT 0,
[IsActive]  BIT NOT NULL DEFAULT 1,
[CreatedBy] INT NOT NULL DEFAULT 0,
[ModifiedBy] INT NOT NULL DEFAULT 0,
[DateCreated] DATETIME2(7) NOT NULL DEFAULT GETDATE(),
[DateModified] DATETIME2(7) NOT NULL DEFAULT GETDATE(),
[Ts] TIMESTAMP NOT NULL,
CONSTRAINT [PK_FormulaVariableSet_Id] PRIMARY KEY([Id]),
CONSTRAINT [IDX_FormulaVariableSet_Code_U_N] UNIQUE ([Code]));

CREATE TABLE [FormulaVariable](
[Id] INT IDENTITY(1,1) NOT NULL,
[FormulaId] INT NOT NULL,
[FormulaVariableSetId] INT NOT NULL,
[DefaultValue] NVARCHAR(2000) NOT NULL DEFAULT '',
[MinValue] NVARCHAR(50) NOT NULL DEFAULT 0,
[MaxValue] NVARCHAR(50) NOT NULL DEFAULT 0,
[TimePeriod] TINYINT NOT NULL DEFAULT 0,
[PeriodStartDate] DATE NOT NULL,
[PeriodEndDate] DATE NOT NULL,
[CurrencyCode] NCHAR(3),
[CreatedBy] INT NOT NULL DEFAULT 0,
[ModifiedBy] INT NOT NULL DEFAULT 0,
[DateCreated] DATETIME2(7) NOT NULL DEFAULT GETDATE(),
[DateModified] DATETIME2(7) NOT NULL DEFAULT GETDATE(),
[Ts] TIMESTAMP NOT NULL,
CONSTRAINT [FK_FormulaVariable_Formula] FOREIGN KEY ([FormulaId]) REFERENCES [Formula] ([Id]),
CONSTRAINT [FK_FormulaVariable_FormulaVariableSet] FOREIGN KEY ([FormulaVariableSetId]) REFERENCES [FormulaVariableSet] ([Id]),
CONSTRAINT [PK_FormulaVariable_Id] PRIMARY KEY([Id]),
CONSTRAINT [IDX_FormulaVariable_FormulaId_FormulaVariableSetId_U_N] UNIQUE ([FormulaId],[FormulaVariableSetId]));

CREATE TABLE [FormulaVariableParam](
[Id] INT IDENTITY(1,1) NOT NULL,
[FormulaVariableId] INT NOT NULL,
[ParamName] NVARCHAR(120) NOT NULL DEFAULT '',
[DefaultValue] NVARCHAR(4000) NOT NULL DEFAULT '',
[CanonicalDataType] TINYINT NOT NULL DEFAULT 1,
[CreatedBy] INT NOT NULL DEFAULT 0,
[ModifiedBy] INT NOT NULL DEFAULT 0,
[DateCreated] DATETIME2(7) NOT NULL DEFAULT GETDATE(),
[DateModified] DATETIME2(7) NOT NULL DEFAULT GETDATE(),
[Ts] TIMESTAMP NOT NULL,
CONSTRAINT [FK_FormulaVariableParam_FormulaVariableId_FormulaVariable_id] FOREIGN KEY ([FormulaVariableId]) REFERENCES [FormulaVariable] ([Id]),
CONSTRAINT [PK_FormulaVariableParam_Id] PRIMARY KEY([Id]));

ALTER TABLE FormulaVariableParam ADD [IsOverridenRuntime] BIT NOT NULL DEFAULT 0;