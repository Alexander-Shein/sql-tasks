CREATE TABLE [Formula](
[Id] INT IDENTITY(1,1) NOT NULL,
[Code] NVARCHAR(20) NOT NULL,
[Description] NVARCHAR(120) NOT NULL,
[FormulaPurpose] TINYINT NOT NULL,
[FormulaType] TINYINT NOT NULL,
[HasSubExpression] BIT NOT NULL,
[SubExpressionCount] TINYINT NOT NULL,
[EditableExpression] NVARCHAR(MAX) NOT NULL,
[EvalExpression] NVARCHAR(MAX) NOT NULL,
[ActivationDate] DATE NOT NULL,
[Notes] NVARCHAR(MAX) NOT NULL,
[IsActive]  BIT NOT NULL,
[CreatedBy] INT NOT NULL,
[ModifiedBy] INT NOT NULL,
[DateCreated] DATETIME2(7) NOT NULL,
[DateModified] DATETIME2(7) NOT NULL,
[Ts] TIMESTAMP NOT NULL,
CONSTRAINT [PK_Formula_Id] PRIMARY KEY([Id]),
CONSTRAINT [IDX_Formula_Code_U_N] UNIQUE ([Code]));

CREATE TABLE [FormulaSubExpression](
[Id] INT IDENTITY(1,1) NOT NULL,
[FormulaId] INT NOT NULL,
[Description] NVARCHAR(80) NOT NULL,
[SubExprIndex] TINYINT NOT NULL,
[EditableSubExpression] NVARCHAR(2000) NOT NULL,
[EvalSubExpression] NVARCHAR(2000) NOT NULL,
[CreatedBy] INT NOT NULL,
[ModifiedBy] INT NOT NULL,
[DateCreated] DATETIME2(7) NOT NULL,
[DateModified] DATETIME2(7) NOT NULL,
[Ts] TIMESTAMP NOT NULL,
CONSTRAINT [FK_FormulaSubExpression_FormulaId_Formula_Id] FOREIGN KEY ([FormulaId]) REFERENCES [Formula] ([Id]),
CONSTRAINT [PK_FormulaSubExpression_Id] PRIMARY KEY([Id]));

CREATE TABLE [FormulaVariableSet](
[Id] INT IDENTITY(1,1) NOT NULL,
[Code] NVARCHAR(50) NOT NULL,
[Description] NVARCHAR(80) NOT NULL,
[CanonicalDataType] TINYINT NOT NULL,
[EvalScope] TINYINT NOT NULL,
[ConstantValue] NVARCHAR(2000) NOT NULL,
[ResolutionType] TINYINT NOT NULL,
[SqlExpr] NVARCHAR(4000) NOT NULL,
[EvalExpr] NVARCHAR(4000) NOT NULL,
[ParamsNumberSqlExpr] TINYINT NOT NULL,
[ParamsNumberEvalExpr] TINYINT NOT NULL,
[IsActive]  BIT NOT NULL,
[CreatedBy] INT NOT NULL,
[ModifiedBy] INT NOT NULL,
[DateCreated] DATETIME2(7) NOT NULL,
[DateModified] DATETIME2(7) NOT NULL,
[Ts] TIMESTAMP NOT NULL,
CONSTRAINT [PK_FormulaVariableSet_Id] PRIMARY KEY([Id]),
CONSTRAINT [IDX_FormulaVariableSet_Code_U_N] UNIQUE ([Code]));
