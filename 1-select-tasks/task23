CREATE TABLE [Formula] (
[Id] INTEGER NOT NULL IDENTITY(1,1),
[Code] NVARCHAR(20) NOT NULL DEFAULT(''),
[Description] NVARCHAR(120) NOT NULL DEFAULT(''),
[FormulaPurpose] TINYINT NOT NULL DEFAULT(1),
[FormulaType] TINYINT NOT NULL DEFAULT(1),
[HasSubExpression] BIT NOT NULL DEFAULT(0),
[SubExpressionCount] TINYINT NOT NULL DEFAULT(0),
[EditableExpression] NVARCHAR(MAX) NOT NULL DEFAULT(''),
[EvalExpression] NVARCHAR(MAX) NOT NULL DEFAULT(''),
[ActivationDate] DATE NOT NULL,
[Notes] NVARCHAR(MAX) NOT NULL DEFAULT(''),
[IsActive] BIT NOT NULL DEFAULT(1),
[CreateBy] INT NOT NULL DEFAULT(0),
[ModifiedBy] INT NOT NULL DEFAULT(0),
[DateCreated] DATETIME2(7) NOT NULL DEFAULT(GETDATE()),
[Ts] TIMESTAMP NOT NULL,
[DateModified] DATETIME2(7) NOT NULL DEFAULT(GETDATE()),
CONSTRAINT [PK_Formula_Id] PRIMARY KEY ([Id]),
CONSTRAINT [IFX_Formula_Code_U_N] UNIQUE ([Code])
);


CREATE TABLE [FormulaSubExpression](
[Id] INTEGER NOT NULL IDENTITY(1,1),
[FormulaId] INTEGER NOT NULL,
[Description] NVARCHAR(80) NOT NULL DEFAULT(''),
[SubExprIndex] TINYINT NOT NULL DEFAULT(0),
[EditableSubExpression] NVARCHAR(2000) NOT NULL DEFAULT(''),
[EvalSubExpression] NVARCHAR(80) NOT NULL DEFAULT(''),
[CreatedBy] INTEGER NOT NULL DEFAULT(0),
[ModifiedBy] INTEGER NOT NULL DEFAULT(0),
[DateCreated] DATETIME2 NOT NULL DEFAULT(GETDATE()),
[DateModified] DATETIME2 NOT NULL DEFAULT(GETDATE()),
[Ts] TIMESTAMP NOT NULL,
CONSTRAINT [PK_FormulaSubExpession_Id] PRIMARY KEY ([Id]),
CONSTRAINT [PK_FormulaSubExpession_FormulaId_Formula_Id] FOREIGN KEY ([FormulaId]) REFERENCES [dbo].[Formula]([Id])
);


CREATE TABLE [FormulaVariableSet](
[Id] INTEGER NOT NULL IDENTITY(1,1),
[Code] NVARCHAR(50) NOT NULL DEFAULT(''),
[Description] NVARCHAR(80) NOT NULL DEFAULT(''),
[CanonicalDataType] TINYINT NOT NULL DEFAULT(1),
[EvalScope] TINYINT NOT NULL DEFAULT(1),
[ConstantValue] NVARCHAR(2000) NOT NULL DEFAULT(''),
[ResolutionType] TINYINT NOT NULL DEFAULT(1),
[SqlExpr] NVARCHAR(4000) NOT NULL DEFAULT(''),
[EvalExpr] NVARCHAR(4000) NOT NULL DEFAULT(''),
[ParamsNumberSqlExpr] TINYINT NOT NULL DEFAULT(0),
[ParamsNumberEvalExpr] TINYINT NOT NULL DEFAULT(0),
[IsActive] BIT NOT NULL DEFAULT(1),
[CreateBy] INT NOT NULL DEFAULT(0),
[ModifiedBy] INT NOT NULL DEFAULT(0),
[DateCreated] DATETIME2(7) NOT NULL DEFAULT(GETDATE()),
[DateModified] DATETIME2(7) NOT NULL DEFAULT(GETDATE()),
[Ts] TIMESTAMP NOT NULL,
CONSTRAINT [PK_FormulaVariableSet_Id] PRIMARY KEY ([Id]),
CONSTRAINT [IDX_FormulaVariableSet_Code_U_N] UNIQUE ([Code])
);


CREATE TABLE [FormulaVariable](
[Id] INTEGER NOT NULL IDENTITY(1,1),
[FormulaId] INTEGER NOT NULL,
[FormulaVariableSetId] INTEGER NOT NULL,
[DefaultValue] NVARCHAR(2000) NOT NULL DEFAULT(''),
[MinValue] VARCHAR(50) NOT NULL DEFAULT(0),
[MaxValue] NVARCHAR(50) NOT NULL DEFAULT(0),
[TimePeriod] TINYINT NOT NULL DEFAULT(0),
[PeriodStartDate] DATETIME,
[PeriodEndDate] DATETIME,
[CurrencyCode] NCHAR(3),
[CreatedBy] INTEGER NOT NULL DEFAULT(0),
[ModifiedBy] INTEGER NOT NULL DEFAULT(0),
[DateCreated] DATETIME2 NOT NULL DEFAULT(GETDATE()),
[DateModified] DATETIME2 NOT NULL DEFAULT(GETDATE()),
[Ts] TIMESTAMP NOT NULL,
CONSTRAINT [PK_FormulaVariable_Id] PRIMARY KEY ([Id]),
CONSTRAINT [PK_FormulaVariable_Formula] FOREIGN KEY ([FormulaId]) REFERENCES [dbo].[Formula]([Id]),
CONSTRAINT [PK_FormulaVariable_FormulaVariableSet] FOREIGN KEY ([FormulaVariableSetId]) REFERENCES [dbo].[FormulaVariableSet]([Id]),
CONSTRAINT [IDX_FormulaVariable_FormulaId_FormulaVariableSetId_U_N] UNIQUE ([FormulaId], [FormulaVariableSetId])
);

CREATE TABLE [FormulaVariableParam](
[Id] INTEGER NOT NULL IDENTITY(1,1),
[FormulaVariableId] INTEGER NOT NULL,
[ParamName] NVARCHAR(120) NOT NULL DEFAULT(''),
[DefaultName] NVARCHAR(4000) NOT NULL DEFAULT(''),
[CanonicalDataType] TINYINT NOT NULL DEFAULT(1),
[IsOverridenRuntime] BIT NOT NULL DEFAULT(0),
[CreatedBy] INT NOT NULL DEFAULT(0),
[ModifiedBy] INT NOT NULL DEFAULT(0),
[DateCreated] DATETIME2(7) NOT NULL DEFAULT(GETDATE()),
[DateModified] DATETIME2(7) NOT NULL DEFAULT(GETDATE()),
[Ts] TIMESTAMP NOT NULL,
CONSTRAINT [PK_FormulaVariableParam_Id] PRIMARY KEY ([Id]),
CONSTRAINT [FK_FormulaVariableParam_FormulaVariableId_FormulaVariable_Id] FOREIGN KEY ([Id]) REFERENCES [dbo].[FormulaVariable]([Id])
);

CREATE TABLE [FormulaHistory] (
[Id] INTEGER NOT NULL  IDENTITY(1,1),
[FormulaId] INTEGER NOT NULL,
[Code] NVARCHAR(20) NOT NULL,
[Description] NVARCHAR(80) NOT NULL DEFAULT(''),
[FormulaPurpose] TINYINT NOT NULL DEFAULT(1),
[FormulaType] TINYINT NOT NULL DEFAULT(1),
[HasSubExpression] BIT NOT NULL DEFAULT(0),
[SubExpressionCount] TINYINT NOT NULL DEFAULT(0),
[EditableExpression] NVARCHAR(MAX) NOT NULL DEFAULT(''),
[EvalExpression] NVARCHAR(MAX) NOT NULL DEFAULT(''),
[ActivationDate] DATE NOT NULL,
[Notes] NVARCHAR(MAX) NOT NULL DEFAULT(''),
[StartValidDate] DATE NOT NULL,
[EndValidDate] DATE NOT NULL,
[IsActive] BIT NOT NULL DEFAULT(1),
[CrudAction] TINYINT NOT NULL DEFAULT(1),
[CreatedBy] INT NOT NULL DEFAULT(0),
[ModifiedBy] INT NOT NULL DEFAULT(0),
[DateCreated] DATETIME2(7) NOT NULL DEFAULT(GETDATE()),
[DateModified] DATETIME2(7) NOT NULL DEFAULT(GETDATE()),
[Ts] TIMESTAMP NOT NULL,
CONSTRAINT [PK_FormulaHistory_Id] PRIMARY KEY ([Id]),
INDEX [IDX_FormulaHistory_FormulaId_N_N] ([FormulaId])
);

CREATE TABLE [FormulaSubExpressionHistory] (
[Id] INTEGER NOT NULL  IDENTITY(1,1),
[FormulaHistoryId] INTEGER NOT NULL,
[FormulaSubExpressionId] INT NOT NULL,
[Description] NVARCHAR(80) NOT NULL DEFAULT(''),
[EditableSubExpression] NVARCHAR(2000) NOT NULL DEFAULT(''),
[EvalSubExpression] NVARCHAR(2000) NOT NULL DEFAULT(''),
[SubExprIndex] TINYINT NOT NULL DEFAULT(0),
[CrudkAction] TINYINT NOT NULL DEFAULT(1),
[CreatedBy] INT NOT NULL DEFAULT(0),
[ModifiedBy] INT NOT NULL DEFAULT(0),
[DateCreated] DATETIME2(7) NOT NULL DEFAULT(GETDATE()),
[DateModified] DATETIME2(7) NOT NULL DEFAULT(GETDATE()),
[Ts] TIMESTAMP NOT NULL,
CONSTRAINT [PK_FormulaSubExpessionHistory_FormulaHistoryId_FormulaHistory_Id] FOREIGN KEY ([FormulaHistoryId]) REFERENCES [dbo].[FormulaHistory]([Id]),
CONSTRAINT [PK_FormulaSubExpressionHistory_Id] PRIMARY KEY ([Id]),
INDEX [IDX_FormulaSubExpressionHistory_FormulaSubExpressionId_N_N] ([FormulaHistoryId])
);

CREATE TABLE [FormulaVariableSetHistory] (
[Id] INTEGER NOT NULL  IDENTITY(1,1),
[FormulaVariableSetId] INTEGER NOT NULL,
[Code] NVARCHAR(50) NOT NULL DEFAULT(''),
[Description] NVARCHAR(80) NOT NULL DEFAULT(''),
[CanonicalDataType] TINYINT NOT NULL DEFAULT(1),
[EvalScope] TINYINT NOT NULL DEFAULT(1),
[ConstantValue] NVARCHAR(2000) NOT NULL DEFAULT(''),
[ResolutionType] TINYINT NOT NULL DEFAULT(1),
[SqlExpr] NVARCHAR(4000) NOT NULL DEFAULT(''),
[EvalExpr] NVARCHAR(4000) NOT NULL DEFAULT(''),
[ParamsNumberSqlExpr] TINYINT NOT NULL DEFAULT(0),
[ParamsNumberEvalExpr] TINYINT NOT NULL DEFAULT(0),
[StartValidDate] DATE NOT NULL,
[EndValidDate] DATE NOT NULL,
[IsActive] BIT NOT NULL DEFAULT(1),
[CrudAction] TINYINT NOT NULL DEFAULT(1),
[CreatedBy] INT NOT NULL DEFAULT(0),
[ModifiedBy] INT NOT NULL DEFAULT(0),
[DateCreated] DATETIME2(7) NOT NULL DEFAULT(GETDATE()),
[DateModified] DATETIME2(7) NOT NULL DEFAULT(GETDATE()),
[Ts] TIMESTAMP NOT NULL,
CONSTRAINT [PK_FormulaVariableSetHistory_Id] PRIMARY KEY ([Id]),
INDEX [IDX_FormulaVariableSetHistory_FormulaVariableSetId_N_N] ([FormulaVariableSetId])
);

CREATE TABLE [FormulaVariableHistory] (
[Id] INTEGER NOT NULL  IDENTITY(1,1),
[FormulaHistoryId] INTEGER NOT NULL,
[FormulaVariableSetHistoryId] INTEGER NOT NULL,
[FormulaVariableId] INTEGER NOT NULL,
[FormulaVariableSetId] INTEGER NOT NULL,
[DefaultValue] NVARCHAR(2000) NOT NULL DEFAULT(''),
[MinValue] NVARCHAR(50) NOT NULL DEFAULT(0),
[MaxValue] VARCHAR(50) NOT NULL DEFAULT(0),
[Description] NVARCHAR(80) NOT NULL DEFAULT(''),
[TimePeriod] TINYINT NOT NULL DEFAULT(0),
[PeriodStartDate] DATE NOT NULL,
[PeriodEndDate] DATE NOT NULL,
[CurrencyCode] NVARCHAR(3) NOT NULL,
[CrudkAction] TINYINT NOT NULL DEFAULT(1),
[CreatedBy] INT NOT NULL DEFAULT(0),
[ModifiedBy] INT NOT NULL DEFAULT(0),
[DateCreated] DATETIME2(7) NOT NULL DEFAULT(GETDATE()),
[DateModified] DATETIME2(7) NOT NULL DEFAULT(GETDATE()),
[Ts] TIMESTAMP NOT NULL,
CONSTRAINT [PK_FormulaVariableHistory_FormulaHistoryId_FormulaHistory_Id] FOREIGN KEY ([FormulaHistoryId]) REFERENCES [dbo].[FormulaHistory]([Id]),
CONSTRAINT [PK_FormulaVariableHistory_FormulaVariableSetHistoryId_FormulaVariableSetHistory_Id] FOREIGN KEY ([FormulaVariableSetHistoryId]) REFERENCES [dbo].[FormulaVariableSetHistory]([Id]),
INDEX [IDX_FormulaVariableHistory_FormulaVariableId_N_N] ([FormulaVariableId]),
INDEX [IDX_FormulaVariableHistory_FormulaVariableSetId_N_N] ([FormulaVariableSetId]),
CONSTRAINT [PK_FormulaVariableHistory_Id] PRIMARY KEY ([Id])
);

CREATE TABLE [FormulaVariableParamHistory](
[Id] INTEGER NOT NULL IDENTITY(1,1),
[FormulaVariableHistoryId] INTEGER NOT NULL,
[FormulaVariableParamId] INTEGER NOT NULL,
[ParamName] NVARCHAR(120) NOT NULL DEFAULT(''),
[FormulaVariable] INTEGER NOT NULL,
[DefaultValue] NVARCHAR(4000) NOT NULL DEFAULT(''),
[CanonicalDataType] TINYINT NOT NULL DEFAULT(1),
[CreatedBy] INT NOT NULL DEFAULT(0),
[IsOverridenRuntime] BIT NOT NULL DEFAULT(0),
[ModifiedBy] INT NOT NULL DEFAULT(0),
[CrudAction] TINYINT NOT NULL DEFAULT(1),
[DateCreated] DATETIME2(7) NOT NULL DEFAULT(GETDATE()),
[DateModified] DATETIME2(7) NOT NULL DEFAULT(GETDATE()),
[Ts] TIMESTAMP NOT NULL,
CONSTRAINT [FK_FormulaVariableParamHistory_FormulaVariableHistoryId_FormulaVariableHistory_Id] FOREIGN KEY ([FormulaVariableHistoryId]) REFERENCES [dbo].[FormulaVariableHistory]([Id]),
CONSTRAINT [PK_FormulaVariableParamHistory_Id] PRIMARY KEY ([Id]),
INDEX [IDX_FormulaVariableParamHistory_FormulaVariableParamId_N_N] ([FormulaVariableParamId]),
INDEX [IDX_FormulaVariableParamHistory_FormulaVariableId_N_N] ([FormulaVariableHistoryId])
);

